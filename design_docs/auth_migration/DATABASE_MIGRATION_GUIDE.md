# Database Migration Guide: NextAuth → Better Auth

## Overview

This migration updates the database schema from NextAuth v4 to Better Auth while preserving all existing data. Uses Prisma's native migration system for safe, trackable schema changes.

## Approach

**Prisma Native Migration** (Recommended)
- Uses `prisma migrate` commands
- Generates SQL automatically from schema changes
- Version controlled migration files
- Automatic rollback support
- Type-safe schema updates

## Files

1. **`/prisma/schema.prisma`** - Updated schema (Better Auth)
2. **`schema-better-auth.prisma`** - Reference schema (for comparison)
3. **Migration files** - Generated by Prisma in `/prisma/migrations/`

## Schema Changes Summary

### User Table
- ✅ Added `displayUsername` field (Better Auth username plugin)
- ✅ `username` field already exists
- ✅ Removed `password` field (moved to Account table)

### Account Table
- ✅ Renamed `refresh_token` → `refreshToken` (camelCase)
- ✅ Renamed `access_token` → `accessToken`
- ✅ Renamed `expires_at` → `expiresAt`
- ✅ Renamed `token_type` → `tokenType`
- ✅ Renamed `id_token` → `idToken`
- ✅ Renamed `session_state` → `sessionState`
- ✅ Added `accountId`, `providerId` (Better Auth)
- ✅ Added `accessTokenExpiresAt`, `refreshTokenExpiresAt`
- ✅ Added `password` field (for credentials auth)
- ✅ Added `createdAt`, `updatedAt` timestamps
- ⚠️ Legacy fields kept for backwards compatibility

### Session Table
- ✅ Renamed `sessionToken` → `token`
- ✅ Renamed `expires` → `expiresAt`
- ✅ Added `ipAddress` (security tracking)
- ✅ Added `userAgent` (security tracking)
- ✅ Added `createdAt`, `updatedAt` timestamps

### Verification Table
- ✅ Renamed table `VerificationToken` → `Verification`
- ✅ Added `id` as primary key (Better Auth uses single PK)
- ✅ Renamed `token` → `value`
- ✅ Renamed `expires` → `expiresAt`
- ✅ Added `createdAt`, `updatedAt` timestamps
- ⚠️ Removed composite primary key `[identifier, token]`

### Site Settings
- ✅ Added `ENABLE_IMPORT_API` setting (default: `false`)

## Migration Steps

### Step 1: Backup Database

**CRITICAL: Always backup before migration!**

```bash
# PostgreSQL backup
pg_dump -U rpgwiki -h localhost rpgwiki > backup_before_better_auth_$(date +%Y%m%d_%H%M%S).sql

# Or using Docker/K8s
kubectl exec -n rpg-wiki-demo rpg-wiki-postgres-xxxx -- pg_dump -U rpgwiki rpgwiki > backup.sql
```

### Step 2: Review Schema Changes

The schema in `/prisma/schema.prisma` has been updated with Better Auth models. Review the changes:

```bash
# See what changed
git diff prisma/schema.prisma
```

**Key changes:**
- User: Added `displayUsername` field
- Account: Renamed fields to camelCase, added Better Auth fields
- Session: Renamed to use `token`, added security tracking
- Verification: Renamed from VerificationToken, restructured

### Step 3: Generate Prisma Migration

**Development Environment:**

```bash
# Generate migration (creates SQL automatically)
npx prisma migrate dev --name better_auth_migration

# This will:
# 1. Create migration SQL in /prisma/migrations/
# 2. Apply migration to database
# 3. Regenerate Prisma client
```

**Production Environment:**

```bash
# Generate migration locally first (dev)
npx prisma migrate dev --name better_auth_migration

# Commit migration files to git
git add prisma/migrations/
git commit -m "feat: migrate to Better Auth schema"

# Deploy to production (runs migrations only, no prompts)
npx prisma migrate deploy
```

### Step 4: Review Generated Migration

Prisma will create a migration file like:
```
/prisma/migrations/20251210_better_auth_migration/migration.sql
```

Open and verify the SQL:
- Check all column renames are correct
- Ensure data preservation (no DROP without backup)
- Verify constraints and indexes

### Step 5: Verify Migration

After Prisma migration completes, verify the changes:

```sql
-- Check User table
SELECT id, username, "displayUsername", email, "emailVerified", "createdAt" 
FROM "User" 
LIMIT 5;

-- Check Session table (should have 'token' not 'sessionToken')
SELECT id, token, "userId", "expiresAt", "ipAddress", "createdAt"
FROM "Session"
LIMIT 5;

-- Check Account table (camelCase fields)
SELECT id, "userId", "providerId", "accountId", "refreshToken", "password", "createdAt"
FROM "Account"
LIMIT 5;

-- Check Verification table (renamed from VerificationToken)
SELECT id, identifier, value, "expiresAt", "createdAt"
FROM "Verification"
LIMIT 5;

-- Check feature flag
SELECT * FROM "SiteSetting" WHERE key = 'ENABLE_IMPORT_API';
```

### Step 6: Verify Prisma Client

Prisma client is automatically regenerated by `migrate dev`. Verify it's working:

```bash
# Check generated types
cat src/generated/prisma/index.d.ts | grep -A 5 "model User"
```

### Step 7: Test in Development

Before deploying to production:

```bash
# Start dev server
npm run dev

# Test:
# 1. Existing user login (Keycloak)
# 2. Existing user login (credentials)
# 3. Session persistence
# 4. Group memberships
```

## Migration Validation Checklist

- [ ] Database backup created
- [ ] Schema changes reviewed (`git diff prisma/schema.prisma`)
- [ ] Prisma migration generated (`npx prisma migrate dev`)
- [ ] Migration SQL reviewed (in `/prisma/migrations/`)
- [ ] Migration applied successfully (no errors)
- [ ] Verification queries pass
- [ ] Prisma client regenerated automatically
- [ ] Dev server starts without errors
- [ ] Existing users can log in (after Better Auth code deployed)
- [ ] Sessions invalidated (users re-login expected)
- [ ] Group memberships intact
- [ ] ENABLE_IMPORT_API setting exists

## Rollback Plan

### Using Prisma Migrate

If migration fails during development:

```bash
# Reset database to clean state
npx prisma migrate reset

# This will:
# 1. Drop database
# 2. Recreate database
# 3. Run all migrations
# 4. Seed data (if seed script exists)
```

### Using Database Backup

If migration fails in production:

```bash
# Restore from backup
psql -U rpgwiki -d rpgwiki < backup_before_better_auth_YYYYMMDD_HHMMSS.sql

# Mark Prisma migration as not applied (prevents re-run)
# Delete the migration record from _prisma_migrations table
psql -U rpgwiki -d rpgwiki -c "DELETE FROM _prisma_migrations WHERE migration_name LIKE '%better_auth%';"
```

### Revert Code Changes

```bash
# Revert schema to NextAuth version
git checkout HEAD~1 -- prisma/schema.prisma

# Regenerate client
npx prisma generate
```

## Known Issues & Compatibility

### emailVerified Field
- Better Auth expects `boolean`, current schema uses `DateTime?`
- Keeping `DateTime` for now (Prisma/Better Auth compatible)
- Better Auth will handle conversion automatically
- Can migrate to boolean in future if needed (low priority)

### Legacy Account Fields
- `type`, `provider`, `providerAccountId` kept for compatibility
- Better Auth uses `providerId` and `accountId` instead
- Both constraints exist (`@@unique` on both)
- Can remove legacy fields in future migration after Better Auth stabilizes

### Session Invalidation
- **Expected**: All existing sessions will be invalidated
- Field rename (`sessionToken` → `token`) breaks existing sessions
- Users will need to log in again after migration
- This is acceptable and expected behavior

### Password Field Migration
- User.password removed (was optional in NextAuth)
- Account.password added (Better Auth credentials storage)
- **Note**: Password migration NOT implemented
  - Keycloak SSO is primary authentication method
  - Password auth discouraged (use `ENABLE_PASSWORD_AUTH=false`)
  - Existing password users: will need to use Keycloak or have admin reset password
  - See `PASSWORD_AUTH_TOGGLE.md` for password authentication strategy

### Verification Table
- Changed from composite PK to single `id` PK
- May affect existing verification flows
- **Password reset flow**: Admin-managed (see `PASSWORD_AUTH_TOGGLE.md`)
  - Admin sets new password for user
  - User changes it on next login
  - Self-service password reset not implemented (Keycloak handles this)

## Next Steps After Migration

1. **Install Better Auth dependencies**
   ```bash
   npm install better-auth
   npm install better-auth-plugin-username
   ```

2. **Create Better Auth configuration** (`/src/lib/better-auth.ts`)
3. **Update API routes** (replace `getServerSession`)
4. **Update client components** (replace NextAuth client)
5. **Test all authentication flows**
6. **Deploy to staging environment**
7. **Production deployment**

## Support

If you encounter issues:
- Check migration logs for SQL errors
- Verify all fields exist: `\d "User"` in psql
- Check Prisma schema matches database
- Review Better Auth documentation: https://better-auth.com/docs

---

**Migration Status**: Ready to execute
**Estimated Downtime**: 5-10 minutes (database migration + server restart)
**Risk Level**: Medium (reversible with backup)
